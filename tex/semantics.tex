\section{Semantics}

We can now define a meta-interpretation as the structure needed to
give a meaning to index and timestamp terms. A meta-interpretation
also induces a translation from a meta-logic signature $\Sigma$
to some base logic signature $\Sigma^I$. For example, if
$\Sigma$ contains a name $\mathsf{n}$ with index arity $1$, and
the meta-interpretation interprets indices in a domain $D_\I = \{
  17, 22 \}$, the base logic signature will feature
two names $\mathsf{n}_{17}$ and $\mathsf{n}_{22}$.

As in the \BC model, we model arbitrary messages produced by the attacker
using free function symbols $\G = \{g_i | i \in \mathbb{N}\}$. We assume
from now on that our signature contains such symbols.

\paragraph{Meta-interpretation of a trace}

We construct, for each symbolic trace, a meta-interpretation representing
the trace. Some details of this definition will be understood in the next
section, where we identify some axioms that hold in all such
meta-interpretations.

\begin{definition}
  Given an abstract trace $\tr = \alpha_1\ldots\alpha_n$,
  we define the meta-interpretation $I_\tr$ as follows:
  \begin{itemize}
    \item an index domain $\D_\I$, which is the set of indices that occur in $\tr$;
    \item a timestamp domain $\D_\XT = \{ t_0 \} \uplus \{ a(\ov{n}) : a\in\Actions_k,
      \ov{n}\in\D_\I^k \}$;
    \item arbitrary mappings $\sigma_\I : \I \to D_\I$
      and $\sigma_\XT : \XT \to D_\XT$ that interpret index and
      timestamp variables as elements of their respective domains;
    \item a total ordering $\leq$, such that $t_0\leq t$ for all $t\in\D_\XT$,
      and $\alpha\leq\beta$ if $\alpha$ occurs before $\beta$ in $\tr$;
    \item a predecessor function $p$ mapping $t_0$ to itself and all
      other timestamps to their predecessor according to $\leq$;
    \item a subset $H_\XT\subseteq D_\XT$  of actions that occur in $\tr$,
      i.e.\ $H_\XT=\{\alpha_i : i\in[1;n]\}$;
    \item for each constant $a \in \Actions$ of index arity $k$,
    an interpretation $\hat{a} : D_\I^k \to D_\XT$ such that
    $\hat{a}(\ov{n}) = a(\ov{n})$;
    \item for each macro symbol $m \in \M$ of index
      arity $k$ and arity $n$, an interpretation
      $\hat{m} : D_\I^k \times \Msg_\Sigma^n \times D_\XT \to \Msg^{I_\tr}_\Sigma$,
      where $\Msg^{I_\tr}_\Sigma$ is the set of terms of the base
      logic for the (base logic) signature
      $(\F^{I_\tr},\N^{I_\tr})$ with
      $$\F^{I_\tr} =
        \{ f_{e_1,\ldots,e_k} : f \in \F_k, e_1,\ldots,e_k \in D_\I \}
        \text{ and }
        \N^{I_\tr} = \{ \mathsf{n}_{e_1,\ldots,e_k} : \mathsf{n}\in\N_k,
        e_1,\ldots,e_k\in D_\I \}.$$
      \footnote{\adrien{The interpretation of macros can depend on the precise element of $\D_\T$ it is interpreted at. In the tool, this is more restricted. E.g.\ $\hat{m}@a[i]$ can only depend on $a$, not on $i$  (except to re-use $i$ in the term). Instead, we could interpret macro symbol as terms of the meta-logic (with restrictions to have termination).}}
    \begin{itemize}
      \item $\hat{\minp}$ and $\hat{\mout}$ have arbitrary values on $t_0$
      \item \solene{$\hat{s}(t_0) =$ ???
      ---
      I do not know what should I write here, because the value we give to
      $\hat{s}(t_0)$ must be a term of the base logic for the (base logic)
      signature $(\F^{I_\tr},\N^{I_\tr})$.
      But the signature $(\F^{I_\tr},\N^{I_\tr})$ is not known at the time
      we define a protocol (which seems the appropriate place to give the
      initialisation parameters of each memory cells).}
      \item otherwise, $\hat{\minp}$, $\hat{\mout}$ and $\hat{s}$
      are uniquely defined by the following
      conditions, for all $i\in[1;n]$:
      $$\hat{\minp}(\alpha_i) =
      g_{i}(\hat{\mout}(\alpha_1),\ldots,\hat{\mout}(\alpha_{i-1}))$$
      $$\hat{\mout}(\alpha_i) = o_{\alpha_i}
      \{x_{\alpha_j}\mapsto\hat{\minp}(\alpha_j)\}_{j \leq i}
      \{x^s_{\alpha_i}\mapsto\hat{s}(\alpha_i)\}$$
      $$\hat{s}(\alpha_i) = u_{\alpha_{i-1}}^{s}
      \{x_{\alpha_j}\mapsto\hat{\minp}(\alpha_j)\}_{j \leq i-1}\{
      x^s_{\alpha_{i-1}}\mapsto\hat{s}(\alpha_{i-1})\}$$
    \end{itemize}
  \end{itemize}
\end{definition}

Note that, for each name $\mathsf{n}\in \N$ and indices $n_1,\ldots,n_k \in
D_\I$, $\mathsf{n}_{n_1,\ldots,n_k}$ refers to a distinct name in $\N^{I_\tr}$.
\adrien{The same is true for function symbols. The thing to remark here is that in a BC computational model, different names will always be interpreted by i.i.d.\ uniform random samplings. This is not true for function symbols ($\ne$ function symbols may have the same interpretation).}

% \begin{definition}
%   A meta-interpretation $I$\footnote{\adrien{I don't like the name meta-interpretation. Meta-model would be better. Or something like trace-model. }}
%   for $\Sigma = (\F,\M,\N,\Actions)$ consists in:
%   \begin{itemize}
%     \item two finite sets $D_\I$ and $D_\XT$ called the index and timestamp
%       domains of the interpretation;
%     \item mappings $\sigma_\I : \I \to D_\I$
%       and $\sigma_\XT : \XT \to D_\XT$ that interpret index and
%       timestamp variables as elements of their respective domains;
%     \item a total ordering $\leq$ over $D_\XT$,
%       a function $p : D_\XT \to D_\XT$ (for interpreting the
%       predecessor\footnote{
%         It does not matter that the predecessor means anything
%         wrt.\ the ordering. We will impose later that it behaves
%         well enough.
%       })
%       and a subset $H_\XT\subseteq D_\XT$ (for identifying timestamps
%       that actuallly happen in an execution\footnote{
%         We cannot identify timestamps freely in the meta-interpretation
%         because we want to be able to use axioms such as
%         $\forall i\neq j.~ a[i] \neq a[j]$ without restricting
%         them to timestamps that really happen.
%         \adrien{I think there are more fundamental reason for that. Considering the way for formulate things, for any $a \in \bbA$ (of arity 1) and $i \in D_\I$, $a[i]$ has an interpretation. But the protocol may not allow for it (because of restrictions). By consequence we need to be able to interpret $a[i]$ without it being valid.}
%       });
%     \item for each constant $a \in \Actions$ of index arity $k$,
%       an interpretation $\hat{a} : D_\I^k \to D_\XT$;
%     \item for each macro symbol $m \in \M$ of index
%       arity $k$ and arity $n$, an interpretation
%       $\hat{m} : D_\I^k \times \Msg_\Sigma^n \times D_\XT \to \Msg^I_\Sigma$,
%       where $\Msg^I_\Sigma$ is the set of terms of the base
%       logic for the (base logic) signature
%       $(\F^I,\N^I)$ with
%       \[
%         \F^I =
%         \{ f_{e_1,\ldots,e_k} : f \in \F_k, e_1,\ldots,e_k \in D_\I \}
%         \text{ and }
%         \N^I = \{ \mathsf{n}_{e_1,\ldots,e_k} : \mathsf{n}\in\N_k,
%         e_1,\ldots,e_k\in D_\I \}.
%       \]
%       \adrien{The interpretation of macros can depend on the precise element of $\D_\T$ it is interpreted at. In the tool, this is more restricted. E.g.\ $\hat{m}@a[i]$ can only depend on $a$, not on $i$  (except to re-use $i$ in the term). Instead, we could interpret macro symbol as terms of the meta-logic (with restrictions to have termination).}
%   \end{itemize}
% \end{definition}


\paragraph{Meta-interpretation of terms and formulas with relation to a trace}

Given a meta-interpretation $I_\tr$ for a given trace, we define the
interpretation in $I_\tr$ of terms of the meta-logic as terms of the base logic.

\begin{definition}
  Given a meta-interpretation $I_\tr$
  we define $(T)^{I_\tr} \in D_\XT$ and $(t)^{I_\tr} \in \Msg^{I_\tr}_\Sigma$ as follows:
  \begin{eqnarray*}
    (\tau)^{I_\tr} &=& \sigma_\XT(\tau) \\
    (\pre(T))^{I_\tr} &=& p((T)^{I_\tr}) \\
    (a[i_1,\ldots,i_k])^{I_\tr} &=& \hat{a}(\sigma_\I(i_1),\ldots,\sigma_\I(i_k))
  \end{eqnarray*}
  \begin{eqnarray*}
    (\mathsf{n}[i_1,\ldots,i_k])^{I_\tr} &=& \mathsf{n}_{\sigma_\I(i_1),\ldots,\sigma_\I(i_k)}
    \\
    (x)^{I_\tr} &=& x
    \\
    (f[i_1,\ldots,i_k](t_1,\ldots,t_n))^{I_\tr} &=&
    f_{\sigma_\I(i_1),\ldots,\sigma_\I(i_k)}\bigl(
      (t_1)^{I_\tr},\ldots,(t_n)^{I_\tr}
    \bigr)
    \\
    (m[i_1,\ldots,i_k](t_1,\ldots,t_n)@T)^{I_\tr} &=&
    \hat{m}(\sigma_\I(i_1),\ldots,\sigma_\I(i_k),
      (t_1)^{I_\tr},\ldots,(t_n)^{I_\tr},
      (T)^{I_\tr})
  \end{eqnarray*}
\end{definition}

\begin{example}
  Consider the meta-logic term $t := \mathsf{h}(\mout@a[i],\mathsf{k}[i])$
  and an interpretation $I_\tr$ with $D_\XT = [1;10]$ and $D_\I = [1;3]$
  (which might be relevant if we are considering traces of ten actions
  with three agents) such that $\sigma_\I(i)=2$ and $\hat{a}(2)=10$
  and $\hat{\mout}(10)=\mathsf{ok}$ (the message outputted at step 10
  is $\mathsf{ok}$ \adrien{I don't like this. It seems that macro can be interperted as the term we want at any timestamp.}).
  We then have $(t)^{I_\tr} = \mathsf{h}(\mathsf{ok},\mathsf{k}_2)$.
\end{example}

The reason why macros take only one timestamp argument is purely practical:
we have no use for more. At this point one might wonder why we separate
indices and actions given that they are interpreted similarly: it is again
purely practical, we will use them for different purposes, and we will need
less structure on indices than on actions, making reasoning easier on them
(one can simply compare indices, there is no ordering and no predecessor
operation on them).


\begin{definition}
  If $I_\tr$ is a meta-interpretation and $e\in D_\I$,
  $I_\tr[i\mapsto e]$ is the interpretation where $\sigma_\I$ is
  modified so that $\sigma_{\I}(i)=e$.
  We define the translation of a meta-logic formula $\phi$
  into the base logic \emph{term} $(\phi)^{I_\tr}$
  as follows:
  \begin{eqnarray*}
    (\phi\wedge\phi')^{I_\tr} &=& (\phi)^{I_\tr} \stackrel{.}{\wedge} (\phi')^{I_\tr}
    \quad \text{and similarly for other boolean connectives} \\
    (\forall i:\idx. \phi)^{I_\tr} &=&
    \stackrel{.}{\wedge}_{e\in D_\I} (\phi)^{I[i\mapsto e]} \\
    (\forall \tau:\timestamp. \phi)^{I_\tr} &=&
    \stackrel{.}{\wedge}_{e\in D_\XT} (\phi)^{I[\tau\mapsto e]} \\
    (\exists i:\idx. \phi)^{I_\tr} &=&
    \stackrel{.}{\vee}_{e\in D_\I} (\phi)^{I[i\mapsto e]} \\
    (\exists \tau:\timestamp. \phi)^{I_\tr} &=&
    \stackrel{.}{\vee}_{e\in D_\XT} (\phi)^{I[\tau\mapsto e]} \\
    (i=i')^{I_\tr} &=&
    \left\{\begin{array}{ll}
      \mathsf{true} & \text{if } \sigma_\I(i)=\sigma_\I(i') \\
      \mathsf{false} & \text{otherwise}
    \end{array}\right. \\
    (T = T')^{I_\tr} &=&
    \left\{\begin{array}{ll}
      \mathsf{true} & \text{if } (T)^{I_\tr} = (T')^{I_\tr} \\
      \mathsf{false} & \text{otherwise}
    \end{array}\right.
    \quad\text{ and similarly for $\leq$} \\
    (\happens(T))^{I_\tr} &=& \mathsf{true}
    \text{ if } (T)^{I_\tr} \in H_\XT
    \text{ and } \mathsf{false} \text{ otherwise}
    \\
    (t=t')^{I_\tr} &=& (t)^{I_\tr} \stackrel{.}{=} (t')^{I_\tr}
  \end{eqnarray*}
\end{definition}

\begin{definition}
  A formula $\phi$ of the meta-logic is said to be valid when,
  for any meta-interpretation $I_\tr$, the base logic formula
  $(\phi)^{I_\tr} \sim \mathsf{true}$ is valid.

  In other words, we have $\M,\sigma\models(\phi)^I\sim\mathsf{true}$
  i.e. the boolean term $(\phi)^{I_\tr}$ is true with overwhelming
  probability in any computational model $\M$ and for any interpretation
  $\sigma$ of the free message variables.\footnote{
  In the tool, we only allow universal quantification over messages, and
  only allow it at toplevel. The validity of such formulas is the same as
  when the variables are left free.}
\end{definition}


\begin{definition}
  A meta-logic formula $\phi$ is a
  logical consequence of a set $S$ of meta-logic formulas
  (noted $S \models \phi$)
  when
  $\M\models(\phi)^{I_\tr}\sim\mathsf{true}$ holds for any $\M$ and ${I_\tr}$ such that
  $\M\models(\psi)^{I_\tr}\sim\mathsf{true}$ holds for all $\psi\in S$.
  \adrien{This definition seems not necessary. We interpret meta-formula as (schemas of) first-order formulas. Hence entailment is exactly first-order logic entailment.}
\end{definition}
